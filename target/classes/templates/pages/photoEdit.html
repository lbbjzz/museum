<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/layout::head"></head>
<body class="hold-transition  sidebar-mini bg-black ">
<div class="wrapper">
    <!-- 顶部导航栏 Navbar -->
    <nav th:replace="fragments/layout::topNav"></nav>
    <!-- 侧边导航栏 Main Sidebar Container -->
    <aside th:replace="fragments/layout::leftAside"></aside>

    <!--页面内容 Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <div class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1 class="text-dark">文物拍照</h1>
                    </div>
                    <!--   面包屑-->
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a href="#">Home</a></li>
                            <li class="breadcrumb-item active">文物拍照</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
        <!-- 页面主要内容Main content -->
        <div class="content">
            <div class="container-fluid">
                <!-- 内容 -->

                <div class="row" style="color: black;">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">


                                <div style="width: 100%;height: 40px;float: left;margin-top: 5px;margin-bottom: 10px">
                                    <input type="button" title="开启摄像头" value="开启摄像头" onclick="getMedia()"
                                           style="color: #fff;background: #0a90f5;outline: none;border-width:0px;width: 25%;height: 30px;border-radius:10px;float:left"/>
                                    <button onclick="takePhoto()"
                                            style="color: #fff;background: #0a90f5;outline: none;border-width:0px;width: 25%;height: 30px;border-radius:10px;margin-left: 12%;float:left">
                                        拍照
                                    </button>
                                    <button style="color: #fff;background: #0a90f5;outline: none;border-width:0px;width: 25%;height: 30px;border-radius:10px;margin-left: 12%;float:left"
                                            name="submit" onclick="photo()">确认并保存
                                    </button>

                                </div>

                                <form th:method="POST" action="photosave" name="addForm">
                                    <div>
                                        <div style="width: 50%">
                                            <label>文物编号 <span class="text-danger">(*)</span></label>
                                            <input required min="1" name="imgId" id="imgFileName"
                                                   type="number" value="" placeholder="请在保存照片前输入文物编号"
                                                   style="border:0.5px solid #378888;border-radius: 10px;width:80%;height: 30px;"/>
                                            <div class="invalid-feedback">文物编号必须大于0!</div>
                                        </div>
                                    </div>
                                </form>


                                <div style="width:30%;height:310px;float: left;margin-left: 10%">
                                    <video id="video" width="300px" height="300px" autoplay="autoplay"></video>
                                </div>
                                <div style="width:30%;height:310px;float: left;margin-left: 20%" class="test">
                                    <canvas id="canvas" width="300px" height="300px" name="files"></canvas>
                                </div>

                            </div>
                            <!-- /.card-body -->
                        </div>
                        <!-- /.card -->
                    </div>
                </div>

            </div><!-- /.container-fluid -->
        </div>
        <!-- /.content -->
    </div>

    <!-- 底部页脚Footer -->
    <footer class="main-footer" th:replace="fragments/layout::footer"></footer>
</div>


<script type="text/javascript">
    //获得video摄像头区域
    let video = document.getElementById("video");

    function getMedia() {
        let constraints = {
            video: {width: 300, height: 300},
            audio: false
        };
        let promise = navigator.mediaDevices.getUserMedia(constraints);
        promise.then(function (MediaStream) {
            video.srcObject = MediaStream;
            video.play();
        }).catch(function (PermissionDeniedError) {
            console.log(PermissionDeniedError);
        })
    }

    function takePhoto() {
        //获得Canvas对象
        let canvas = document.getElementById("canvas");
        let ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, 300, 300);
    }

    function dataURItoBlob(base64Data) {
        var byteString;
        if (base64Data.split(',')[0].indexOf('base64') >= 0)
            byteString = atob(base64Data.split(',')[1]);
        else
            byteString = unescape(base64Data.split(',')[1]);
        var mimeString = base64Data.split(',')[0].split(':')[1].split(';')[0];
        var ia = new Uint8Array(byteString.length);
        for (var i = 0; i < byteString.length; i++) {
            ia[i] = byteString.charCodeAt(i);
        }
        return new Blob([ia], {type: mimeString});
    }

    function photo() {
        let canvas = document.getElementById("canvas");
        let src = canvas.toDataURL("image/png")
        var fd = new FormData();
        var blob = dataURItoBlob(src);
        //fd.append('source_from','webpage_upload')
        fd.append('file', blob);
        //let imgId = //这里用 Jquery 拿到 id = imgFileName  这个value 就好了  我好久不写jquery 了 api忘了 就不查了 你查下就好
        var imgId = document.getElementById("imgFileName").value;
        fd.append("imgId",imgId);
        $.ajax({
            method: 'POST',
            url: '/photosavedemo',
            data: fd,
            cache: false,
            async: false,
            processData: false,
            contentType: false,
            success: function (res) {
                alert(res.msg);
            },
            error: function (err) {
                alert("服务器错误");
            }
        })

        document.addForm.submit();
    }

</script>

</body>
</html>
